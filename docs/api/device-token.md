# デバイストークン API

## 概要

プッシュ通知を受信するためのFCM（Firebase Cloud Messaging）デバイストークンを管理するAPIです。

---

## エンドポイント一覧

| メソッド | URL | 説明 | 認証 |
|----------|-----|------|------|
| `POST` | `/api/device-token/` | トークン登録・更新 | 必要 |
| `DELETE` | `/api/device-token/` | トークン削除 | 必要 |

---

## POST /api/device-token/

FCMデバイストークンを登録または更新します。

### リクエストボディ

```json
{
  "token": "fcm_device_token_string_here",
  "platform": "ios"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| `token` | string | ✓ | FCMデバイストークン |
| `platform` | string | ✓ | プラットフォーム（`ios` または `android`） |

### レスポンス

**成功時（201 Created）- 新規登録**

```json
{
  "message": "Token registered",
  "token_id": 123
}
```

**成功時（200 OK）- 既存トークン更新**

```json
{
  "message": "Token updated",
  "token_id": 123
}
```

| フィールド | 型 | 説明 |
|------------|-----|------|
| `message` | string | 処理結果メッセージ |
| `token_id` | integer | デバイストークンID |

### エラーレスポンス

**400 Bad Request - tokenが未指定**

```json
{
  "error": "token is required"
}
```

**400 Bad Request - platformが不正**

```json
{
  "error": "platform must be 'ios' or 'android'"
}
```

**401 Unauthorized - 認証が必要**

```json
{
  "detail": "認証情報が含まれていません。"
}
```

### 動作

1. リクエストで送信されたトークンがすでに登録されているか確認
2. 既存の場合は、ユーザーとプラットフォーム情報を更新
3. 新規の場合は、新しいレコードを作成
4. トークンは`is_active=True`の状態で保存

### 注意事項

- 同じトークンで複数回リクエストした場合、既存のレコードが更新されます
- トークンはユーザーごとに複数登録可能です（複数デバイス対応）
- アプリの初回起動時とトークン更新時に呼び出してください

---

## DELETE /api/device-token/

FCMデバイストークンを削除します。ログアウト時やアンインストール時に使用します。

### リクエストボディ

```json
{
  "token": "fcm_device_token_string_here"
}
```

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| `token` | string | ✓ | 削除するFCMデバイストークン |

### レスポンス

**成功時（200 OK）**

```json
{
  "message": "Token removed"
}
```

### エラーレスポンス

**400 Bad Request - tokenが未指定**

```json
{
  "error": "token is required"
}
```

**404 Not Found - トークンが見つからない**

```json
{
  "error": "Token not found"
}
```

**401 Unauthorized - 認証が必要**

```json
{
  "detail": "認証情報が含まれていません。"
}
```

### 動作

1. リクエストされたトークンを現在のユーザーのトークンから検索
2. 見つかった場合は削除
3. 見つからない場合は404エラーを返却

### 注意事項

- 自分のアカウントに紐づいているトークンのみ削除可能です
- アプリのログアウト時に呼び出すことを推奨します

---

## プッシュ通知を受信するタイミング

デバイストークンを登録すると、以下のイベント時にプッシュ通知が送信されます：

### 1. レベルアップ通知
ユーザーが経験値を獲得してレベルアップした時

**通知内容例:**
```
タイトル: レベルアップ！
本文: おめでとうございます！レベル5に到達しました！
```

### 2. ランキング入賞通知
ユーザーがレベルランキングでトップ10に入った時

**通知内容例:**
```
タイトル: ランキング入賞！
本文: レベルランキングで3位にランクインしました！
```

### 3. フォロー通知
他のユーザーにフォローされた時

**通知内容例:**
```
タイトル: 新しいフォロワー
本文: @username さんにフォローされました
```

### 4. いいね通知
自分の投稿にいいねされた時

**通知内容例:**
```
タイトル: いいねされました
本文: @username さんが投稿にいいねしました
```

---

## データモデル

### DeviceToken

| フィールド | 型 | 説明 |
|------------|-----|------|
| `id` | integer | デバイストークンID（PK） |
| `user` | ForeignKey | 所有ユーザー |
| `token` | string | FCMデバイストークン（ユニーク） |
| `platform` | string | プラットフォーム（`ios` or `android`） |
| `is_active` | boolean | 有効フラグ |
| `created_at` | datetime | 作成日時 |
| `updated_at` | datetime | 更新日時 |

---

## よくある質問

### Q: トークンはいつ更新されますか？

A: FCMトークンは以下のタイミングで更新される可能性があります：
- アプリの再インストール
- アプリデータのクリア
- デバイスの復元
- Firebaseの内部更新

### Q: 複数のデバイスから同じアカウントにログインできますか？

A: はい。1つのアカウントに複数のデバイストークンを登録できます。すべてのデバイスでプッシュ通知を受信できます。

### Q: ログアウト時にトークンを削除しないとどうなりますか？

A: トークンが残っていても、認証トークンが無効になるためAPIアクセスはできません。ただし、プッシュ通知は引き続き送信される可能性があるため、ログアウト時には削除することを推奨します。

### Q: トークンの有効期限はありますか？

A: 現在、トークンに有効期限はありません。手動で削除されるまで有効です。
